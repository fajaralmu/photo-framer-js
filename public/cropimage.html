<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="description" content="Kafila Media PSB Frame" />
    <meta property="og:title" content="Kafila Media PSB Frame" />
    <meta property="og:url" content="https://kafilamedia.github.io/psbframe/" />
    <meta property="og:description" content="Kafila Media PSB Frame" />
    <meta property="og:site_name" content="kafilamedia" />
    <meta
      property="og:image"
      itemprop="image"
      content="http://kafila.sch.id/assets/img/kiis-stroke.png"
    />
    <meta property="og:type" content="website" />

    <title>Image Cropper</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bluebird/3.3.4/bluebird.min.js"></script>
    <link rel="stylesheet" href="../css/bootstrap.min.css" />
    <link rel="stylesheet" href="../css/cropper.css" />
    <script src="../js/jquery-3.3.1.slim.min.js"></script>
    <script src="../js/popper.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/app.js"></script>
    <script src="../js/html.js"></script>
    <script src="../js/dialogs.js"></script>
 
    <script type="text/javascript">
        const BASE_WIDTH = 400;
        const BASE_HEIGHT = 400;
        var dragInitialPosition = {x:0, y:0}
        var dragLatestPosition = {x:0, y:0}
        var drag = false;
        var clipX = 0;
        var clipY = 0;
        var clipSize = 100;
    </script>
  </head>
  <body>
    <div class="container">
      <h3>Image Cropper</h3>
      <div class="alert alert-success" role="alert">
        <h4 class="alert-heading" >Brief</h4>
        <p id="brief">Click the circle to start movement</p>
      </div>

      <canvas id="main-canvas" id="canvas" ></canvas>
      <div id="image-clip"  ><div id="clip-center"></div></div>
      <div id="controls" class="row">
        
         <div class="col-6">
            <p>X Position</p>
            <input id="rangeX" type="range" value="0" max="400" min="0" autocomplete="off" />
            <output id="output-x" ></output>
        
            <p>Y Position</p> 
            <input id="rangeY" type="range" value="0" max="400" min="0" autocomplete="off" />
            <output id="output-y"  ></output>
          </div>
          <div class="col-6">
            <p>Clip Size</p> 
            <input  id="rangeClipSize" type="range" value="0"  max="400" min="100" autocomplete="off" />
            <p id="output-clip-size"  ></p>
            <p id="drag-position-info"></p>
            <p id="info-draggable"></p>
          </div>

      </div>
    </div>
  </body>
  <script type="text/javascript">
    const imageClip  = byId("image-clip");
    const rangeX = byId("rangeX");
    const rangeY = byId("rangeY");
    const rangeClipSize = byId("rangeClipSize");
    const canvas = byId("main-canvas");
    const canvasCtx = canvas.getContext("2d");
    const IMAGE_URL = "../assets/test.png";
    const centerClip = byId("clip-center");
    

    function setBackground() {

       return new Promise(function(res, rej){
            const img = new Image();
            img.src = IMAGE_URL;
            img.onload = function () {
                 
                canvas.setAttribute("width", img.width);
                canvas.setAttribute("height", img.height);
                
                canvasCtx.clearRect(0,0,canvas.width, canvas.height); 
                canvasCtx.drawImage(img, 0, 0, canvas.width, canvas.height);
                canvasCtx.fillStyle = 'rgba(100,100,100,0.5)';
                canvasCtx.fillRect(0,0,canvas.width, canvas.height);
                imageClip.style.marginTop = -1* parseInt(canvas.height+9)+'px';
                // rangeY.max = canvas.height;
                rangeX.max = canvas.width;
                rangeY.max = canvas.height;
                rangeY.value = canvas.height;
                clipY = rangeY.value;
               res(0);
            };
            img.onerror = function(e){
               rej(e);
            }
       });
      
    }

    
    function release(){
        setDragStatus(false);
        console.debug("On Mouse Up");
       
    }

    function setDragStatus(status){
      drag = status;
      showDragInfo();
    }

    function updateClipX(x){
       
        updateClipXY(x, clipY);
    }

    function updateClipY(y){
        
        updateClipXY(clipX, y);
    }

    function updateClipSize(size){
        clipSize = size;
        updateBackgroundPosition();
    }

    function updateClipXY(x, y){
        clipX = -x;
        rangeX.value = x; 
        byId("output-x").innerHTML = x;

        clipY = y;
        rangeY.value = y; 
        byId("output-y").innerHTML = y; 
        updateBackgroundPosition();
    }

    function updateBackgroundPosition(){
        imageClip.style.marginLeft = -clipX + 'px';
        imageClip.style.marginTop =  ( -clipY-9)+'px';

        imageClip.style.width = clipSize+'px';
        imageClip.style.height = clipSize+'px';
        imageClip.style.backgroundPosition = clipX+"px "+(clipY-canvas.height)+"px";
       
        centerClip.style.marginTop =( (clipSize/2-25) )+'px';

        byId("output-clip-size").innerHTML = clipSize + " BG POS "+ imageClip.style.backgroundPosition;
    }

    function initEventsAndProperties(){
        //Props//
        imageClip.style.backgroundImage = 'url('+IMAGE_URL+')';
        canvas.width = BASE_WIDTH;
        canvas.height = BASE_HEIGHT;

        //Events//
        canvas.onmousedown = function(e){ setDragStatus(true) };
        canvas.onmouseup =function(e){ setDragStatus(false) };
        rangeX.onchange = function(e){
            updateClipX(e.target.value);
        }
        rangeY.onchange = function(e){
            updateClipY(e.target.value);
        }
        rangeClipSize.onchange = function(e){
            updateClipSize(e.target.value);
        }
        centerClip.onmousedown=toggleDrag;
        // centerClip.onmouseup=function(e){ console.debug("onmouseup"); stopDrag(e) };
        // centerClip.onmouseout=function(e){ console.debug("onmouseout"); stopDrag(e) };
    }

    function showDragInfo(){
      byId("info-draggable").innerHTML = "DRAG "+drag;
      if(!drag){
        byId("brief").innerHTML = "Click the circle to start movement";
      } else {
        byId("brief").innerHTML = "Specify movement point, Click again to stop movement";
      }
    }

    function toggleDrag(evt){
      let briefInfo;
      if(!drag){ 
        startDrag(evt);
      } else { 
        stopDrag(evt);
        drag = false;
      }
      showDragInfo();
    }

    function startDrag(evt){
        
        drag = true;
        showDragInfo();
        // dragInitialPosition.x =  evt.clientX;
        // dragInitialPosition.y =  evt.clientY;
        console.debug("Start Drag at", evt.clientX, ",", evt.clientY);
    }

    function stopDrag(evt){
        // drag = false; 
        dragLatestPosition.x =  evt.clientX;
        dragLatestPosition.y =  evt.clientY;
        console.debug("Stopped Drag at", dragInitialPosition.x, ",", dragInitialPosition.y);
        showDragInfo();
    }

    function mouseListener(evt) {
        if(!drag){
           //console.debug("Drag disabled");
            return;
        }
     // const canvas = evt.target;
      const rect = canvas.getBoundingClientRect();
      const position = {
        x: Math.ceil(evt.clientX - rect.left),
        y: Math.ceil(evt.clientY - rect.top),
      };
      if(position.x < 0 || position.x > (canvas.width)) {
            return;
      }
      if(position.y < 0 || position.y > (canvas.height)) {
            console.debug("y position invalid");
            return;
      }

      byId("drag-position-info").innerHTML = position.x+","+position.y;
      updateClipXY( position.x-(clipSize/2), (canvas.height-position.y )+(clipSize/2));
     
      canvasCtx.fillRect(position.x, position.y, 1, 1);
    }

    initEventsAndProperties();
    setBackground().then(function(){
        console.debug("background set");
        
        updateBackgroundPosition();
       
   }).catch(function(){});
    window.onmousemove = mouseListener;
    window.onkeyup = function(e){
      const code = e.with || e.keyCode;
      if(parseInt(code) == 68){
        setDragStatus(!drag);
      }
    }
    
  </script>
</html>
