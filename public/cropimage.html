<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="description" content="Kafila Media PSB Frame" />
    <meta property="og:title" content="Kafila Media PSB Frame" />
    <meta property="og:url" content="https://kafilamedia.github.io/psbframe/" />
    <meta property="og:description" content="Kafila Media PSB Frame" />
    <meta property="og:site_name" content="kafilamedia" />
    <meta
      property="og:image"
      itemprop="image"
      content="http://kafila.sch.id/assets/img/kiis-stroke.png"
    />
    <meta property="og:type" content="website" />

    <title>Image Cropper</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bluebird/3.3.4/bluebird.min.js"></script>
    <link rel="stylesheet" href="../css/bootstrap.min.css" />
    <link rel="stylesheet" href="../css/app.css" />
    <script src="../js/jquery-3.3.1.slim.min.js"></script>
    <script src="../js/popper.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/app.js"></script>
    <script src="../js/html.js"></script>
    <script src="../js/dialogs.js"></script>

    <style>
      #main-canvas {
        border: solid 2px #cccccc;
        position: relative;
      }
      .container {
        margin: auto;
        padding: 10px;
         /* text-align: center; */
      }

      #image-clip{
          margin:auto; 
          border:solid 2px #cccccc; 
          position: absolute;
          background-repeat: no-repeat;
          transition-duration: 200ms;
      }
      #controls{
          text-align: left;
      }
    </style>
    <script type="text/javascript">
        const BASE_WIDTH = 400;
        const BASE_HEIGHT = 400;
    </script>
  </head>
  <body>
    <div class="container">
      <h3>Image Cropper</h3>
      
      <canvas id="main-canvas" id="canvas" ></canvas>
      <div id="image-clip"></div>
      <div id="controls">
        
        <form >
            <p>X Position</p>
            <input id="rangeX" type="range" value="0" max="400" min="0" autocomplete="off" />
            <output id="output-x" ></output>
        
            <p>Y Position</p> 
            <input id="rangeY" type="range" value="0" max="400" min="0" autocomplete="off" />
            <output id="output-y"  ></output>

            <p>Clip Size</p> 
            <input id="rangeClipSize" type="range" value="0"  max="400" min="100" autocomplete="off" />
            <output id="output-clip-size"  ></output>
        </form>
      </div>
    </div>
  </body>
  <script type="text/javascript">
    const imageClip  = byId("image-clip");
    const rangeX = byId("rangeX");
    const rangeY = byId("rangeY");
    const rangeClipSize = byId("rangeClipSize");
    const canvas = byId("main-canvas");
    const canvasCtx = canvas.getContext("2d");
    const IMAGE_URL = "../assets/test.png";
    var drag = false;
    var clipX = 0;
    var clipY = 0;
    var clipSize = 100;

    function setBackground() {
      const img = new Image();
      img.src = IMAGE_URL;
      img.onload = function () {
        canvas.width = img.width;
        canvas.height = img.height;
        canvasCtx.clearRect(0,0,canvas.width, canvas.height);
       
        canvasCtx.drawImage(img, 0, 0, canvas.width, canvas.height);
        canvasCtx.fillStyle = 'rgba(100,100,100,0.5)';
        canvasCtx.fillRect(0,0,canvas.width, canvas.height);
        imageClip.style.marginTop = -1* parseInt(canvas.height+9)+'px';
        // rangeY.max = canvas.height;
        rangeX.max = canvas.width;
        rangeY.max = canvas.height;
        rangeY.value = canvas.height;
      };
    }

    function mouseListener(evt) {
        if(!drag){
            return;
        }
     // const canvas = evt.target;
      const rect = canvas.getBoundingClientRect();
      const position = {
        x: evt.clientX - rect.left,
        y: evt.clientY - rect.top,
      };
      if(position.x < 0 || position.x > canvas.width) {
          drag = false;
          return;
      }
      if(position.y < 0 || position.y > canvas.height) {
          drag = false;
          return;
      }
     // console.debug("position: ", position);
      canvasCtx.fillRect(position.x, position.y, 1, 1);
    }

    function release(){
        drag = false;
        console.debug("On Mouse Up");
    }

    function updateClipX(x){
        clipX = -x;
        imageClip.style.marginLeft = x + 'px';
        updateBackgroundPosition();
        byId("output-x").innerHTML = clipX;
    }

    function updateClipY(y){
        clipY = y;
        imageClip.style.marginTop =  ( -y-9)+'px';
        updateBackgroundPosition();
        byId("output-y").innerHTML = y;
    }

    function updateClipSize(size){
        clipSize = size;
        updateBackgroundPosition();
    }

    function updateBackgroundPosition(){
        imageClip.style.width = clipSize+'px';
        imageClip.style.height = clipSize+'px';
        imageClip.style.backgroundPosition = clipX+"px "+(clipY-canvas.height)+"px";
        
       
        byId("output-clip-size").innerHTML = clipSize + " BG POS "+ imageClip.style.backgroundPosition;
    }

    function initEvents(){
        imageClip.style.backgroundImage = 'url('+IMAGE_URL+')';
        canvas.width = BASE_WIDTH;
        canvas.height = BASE_HEIGHT;
        canvas.onmousedown = function(e){ drag = true };
        canvas.onmouseup =function(e){ drag = false };
        rangeX.onchange = function(e){
            updateClipX(e.target.value);
        }
        rangeY.onchange = function(e){
            updateClipY(e.target.value);
        }
        rangeClipSize.onchange = function(e){
            updateClipSize(e.target.value);
        }
    }

    setBackground();
    initEvents();
    updateBackgroundPosition();
    window.onmousemove = mouseListener;
  </script>
</html>
