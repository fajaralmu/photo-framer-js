<html>
  <head>
    <meta charset="utf-8" />
    <title>Photo Framer</title>
    <link rel="stylesheet" href="../css/bootstrap.min.css" />
    <script src="../js/jquery-3.3.1.slim.min.js"></script>
    <script src="../js/popper.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/app.js"></script>
    <script src="../js/html.js"></script>
    <script src="../js/dialogs.js"></script>
    <style>
      
      .grid2 {
        display: grid;
        grid-template-columns: 20% 65% 15%;
        grid-column-gap: 10px;
      }

      .row {
        grid-row-gap: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h3>Photo Framer</h3>
      </div>
      <div class="row">
        <div class="col-6">
          <div class="card">
            <div class="card-header">
              Choose Your Photo
            </div>
            <div class="card-body">
              <div class="field grid2">
                <label>Select File</label>
                <input id="input-photo" class="form-control" type="file" />
              </div>
              <div class="field">
                <button id="btn-set-photo" class="btn btn-info">Choose</button>
              </div>
              <div class="field">
                <p>Preview:</p>
                <img id="preview-photo" />
              </div>
              <div class="field grid2">
                <p></p>
                <p></p>
                <p></p>
                <label>Add Text</label>
                <input class="form-control" id="custom-text" />
                <span></span>
                <label>Text X Position</label>
                <input type="range" class="form-control text-modifier" min="0" max="1080"   value="100" id="text-x" />
                <spam id="out-txt-x-pos"></spam>
                <label>Text Y Position</label>
                <input class="form-control text-modifier" min="0" max="1080"  type="range"   value="100" id="text-y" />
                 <spam id="out-txt-y-pos"></spam>
                <label>Text Size</label>
                <input class="form-control text-modifier" min="10" max="200"  type="range"value="50" id="text-size" />
                <spam id="out-txt-size"></spam>
                <label>Text Color</label>
                <input class="form-control text-modifier" type="color"  id="text-color" />
                <spam id="out-txt-color"></spam>
              </div>
            </div>
          </div>
        </div>
        <div class="col-6">
          <div class="card">
            <div class="card-header">
              Choose Your Frame
            </div>
            <div class="card-body">
              <div class="field grid2">
                <label>Select File</label>
                <input id="input-frame" class="form-control" type="file" />
              </div>
              <div class="field">
                <button id="btn-set-frame" class="btn btn-info">Choose</button>
              </div>
              <div class="field">
                <p>Preview:</p>
                <img id="preview-frame" />
              </div>
            </div>
          </div>
        </div>
        <div class="col-12">
          <button id="btn-process" class="btn btn-success">Process</button>
          <button style="color:white" class="btn btn-secondary" id="downloadButton"  >Download as image</button>
          <p></p>
          <canvas style="border: solid 2px #33c1ff;" id="canvas"></canvas>
          <p></p>
        </div>
      </div>
      <a style="display: none;" id="downloadLink"></a>
      <canvas id="temp-canvas" style="display: none;"></canvas>
    </div>
    <script type="text/javascript">
      const inputFrame = byId("input-frame");
      const inputPhoto = byId("input-photo");
      const previewPhoto = byId("preview-photo");
      const previewFrame = byId("preview-frame");
      const canvas = byId("canvas");
      const tempCanvas = byId("temp-canvas");
      const ctx = canvas.getContext("2d");
      const tempCtx = tempCanvas.getContext("2d");
      const inputText = byId("custom-text");
      const textModifiers = document.getElementsByClassName("text-modifier");

      const downloadButton = byId("downloadButton");
      const downloadLink = byId("downloadLink");

      //canvas
      const WIDTH = 1080;
      const HEIGHT = 1080;
      const BG_COLOR = "#FFFFFF";

      var photoImageData = null;
      var frameImageData = null;

      function init() {
        fillPreviewAttrs(previewFrame);
        fillPreviewAttrs(previewPhoto);

        byId("btn-set-photo").onclick = function (e) {
          toBase64(inputPhoto, function (result) {
            previewPhoto.src = result;
            photoImageData = result;
          });
        };
        byId("btn-set-frame").onclick = function (e) {
          toBase64(inputFrame, function (result) {
            previewFrame.src = result;
            frameImageData = result;
          });
        };

        byId("btn-process").onclick = function (e) {
          processPhoto();
        };

        downloadButton.onclick = function (e) {
          
            
            confirmDialog("Download Result?").then(function(confirm){
              if(confirm){
                saveAsImage();
              }
            });
          
        };

        initCanvasSize();
        initTextModifiersEvents();
        setText();
      }

      function initCanvasSize(){
        canvas.width = WIDTH;
        canvas.height = HEIGHT;
        
        tempCanvas.width = WIDTH;
        tempCanvas.height = HEIGHT;
      }

      function initTextModifiersEvents(){
        for (let i = 0; i < textModifiers.length; i++) {
          const element = textModifiers[i];
          element.onchange = function(e){
            processPhoto();
          }
        }
      }

      function saveAsImage() {
        const data = canvas.toDataURL("image/png");
        downloadLink.href = data;
        downloadLink.download = "KafilaFrameResult_"+(new Date()).toISOString()+".png";
        downloadLink.click();
      }

      function processPhoto() {
        if (!frameImageData || !photoImageData) {
          alert("Photo and Frame must be choosen!");
          return;
        }

        //clear
        ctx.fillStyle = BG_COLOR;
        ctx.fillRect(0, 0, WIDTH, HEIGHT);

        //draw
        drawUserPhoto();
      }

      function drawUserPhoto() {
        //User Photo
        const img = new Image();
        img.onload = function () {
          const dimension = caliberateImageSize(img);
          console.debug("resized image dimension: ", dimension);
          tempCanvas.width = dimension.width;
          tempCanvas.height = dimension.height;
          tempCtx.drawImage(img, 0,0, dimension.width, dimension.height);
          
          const newImg = new Image();
          newImg.src = tempCanvas.toDataURL();

          newImg.onload = function(){
            console.debug("IMG SIZE: ", newImg.width ,"x", newImg.height);
            var imageX = 0, imageY = 0;
            const canvasX = 0, canvasY = 0;
            if(dimension.adjustedSide != null){
              if(dimension.adjustedSide == "w"){
                imageX = (dimension.width - WIDTH)/2;
              }else {
                imageY = (dimension.height - HEIGHT)/2;
              }
            }
            // The source newImg is taken from the coordinates (imageX, imageY), 
            // with a width of WIDTH and a height of HEIGHT. 
            // It is drawn to the canvas at (canvasX, canvasY),
            // where it is given a width of WIDTH and a height of HEIGHT.
            ctx.drawImage(newImg, imageX, imageY, WIDTH, HEIGHT, canvasX, canvasY, WIDTH, HEIGHT);

            drawFrame();
          }
        };
        img.src = photoImageData;
      }

      function drawFrame() {
        //Frame
        const frameImg = new Image();
        frameImg.onload = function () {
          ctx.drawImage(frameImg, 0, 0, WIDTH, HEIGHT);
          setText();
        };
        frameImg.src = frameImageData;
      }

      function setText() {
       
        const textX = byId("text-x").value;
        const textY = byId("text-y").value;
        const textSize = byId("text-size").value+"px";
        const textColor = byId("text-color").value;

        byId("out-txt-x-pos").innerHTML = textX;
        byId("out-txt-y-pos").innerHTML = textY;
        byId("out-txt-size").innerHTML = textSize;
        byId("out-txt-color").innerHTML = textColor;

        if (inputText.value == "") {
          return false;
        }
        ctx.fillStyle = textColor;
        ctx.font = textSize+" Arial";
        ctx.fillText(inputText.value, textX, textY);
        return true;
      }

      function fillPreviewAttrs(imgElement) {
        imgElement.width = 200;
        imgElement.height = 200;
        imgElement.className = "img-thumbnail";
        imgElement.src = "#";
      }

      init();
    </script>
  </body>
</html>
